"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("../types");
const types_2 = require("./types");
// @ts-ignore
const hammerhead_1 = __importDefault(require("../../client/core/deps/hammerhead"));
const utils_1 = require("./utils");
const send_request_to_frame_1 = __importDefault(require("../../client/core/utils/send-request-to-frame"));
const dom_1 = require("../../client/core/utils/dom");
const style_1 = require("../../client/core/utils/style");
const { utils, eventSandbox, nativeMethods } = hammerhead_1.default;
const messageSandbox = eventSandbox.message;
const MOUSE_EVENT_OPTIONS = {
    clickCount: 1,
};
const CALCULATE_TOP_LEFT_POINT_REQUEST_CMD = 'native-automation|calculate-top-left-point|request';
const CALCULATE_TOP_LEFT_POINT_RESPONSE_CMD = 'native-automation|calculate-top-left-point|response';
function getLeftTopPoint(driverIframe) {
    const rect = driverIframe.getBoundingClientRect();
    const borders = (0, style_1.getBordersWidthFloat)(driverIframe);
    const paddings = (0, style_1.getElementPaddingFloat)(driverIframe);
    return {
        x: rect.left + borders.left + paddings.left,
        y: rect.top + borders.top + paddings.top,
    };
}
// Setup cross-iframe interaction
messageSandbox.on(messageSandbox.SERVICE_MSG_RECEIVED_EVENT, async (e) => {
    if (e.message.cmd === CALCULATE_TOP_LEFT_POINT_REQUEST_CMD) {
        const iframeWin = e.source;
        const { x, y } = await calculateIFrameTopLeftPoint();
        const iframe = (0, dom_1.findIframeByWindow)(iframeWin);
        const topLeftPoint = getLeftTopPoint(iframe);
        const responseMsg = {
            cmd: CALCULATE_TOP_LEFT_POINT_RESPONSE_CMD,
            topLeftPoint: {
                x: topLeftPoint.x + x,
                y: topLeftPoint.y + y,
            },
        };
        messageSandbox.sendServiceMsg(responseMsg, iframeWin);
    }
});
async function calculateIFrameTopLeftPoint() {
    if (window !== window.parent) {
        const msg = {
            cmd: CALCULATE_TOP_LEFT_POINT_REQUEST_CMD,
        };
        const { topLeftPoint } = await (0, send_request_to_frame_1.default)(msg, CALCULATE_TOP_LEFT_POINT_RESPONSE_CMD, window.parent);
        return topLeftPoint;
    }
    return { x: 0, y: 0 };
}
class CDPEventDescriptor {
    static _isNonCharKeyModifier(modifiers) {
        const nonCharModifiers = [types_2.KeyModifierValues.ctrl, types_2.KeyModifierValues.alt, types_2.KeyModifierValues.meta];
        return nativeMethods.arrayIndexOf.call(nonCharModifiers, modifiers) > -1;
    }
    static _getKeyDownEventText(options) {
        if (options.isNewLine)
            return '\r';
        if (options.keyProperty.length === 1 && !CDPEventDescriptor._isNonCharKeyModifier(options.modifiers))
            return options.keyProperty;
        return '';
    }
    static createKeyDownOptions(options) {
        const text = CDPEventDescriptor._getKeyDownEventText(options);
        return {
            type: text ? 'keyDown' : 'rawKeyDown',
            modifiers: options.modifiers || 0,
            windowsVirtualKeyCode: options.keyCode,
            key: options.keyProperty,
            commands: options.commands,
            text,
        };
    }
    static createKeyUpOptions(options) {
        return {
            type: 'keyUp',
            modifiers: options.modifiers || 0,
            key: options.keyProperty,
            windowsVirtualKeyCode: options.keyCode,
        };
    }
    static async createMouseEventOptions(type, options) {
        const { x, y } = await calculateIFrameTopLeftPoint();
        return utils.extend({
            x: options.options.clientX + x,
            y: options.options.clientY + y,
            modifiers: (0, utils_1.calculateKeyModifiersValue)(options.options),
            button: (0, utils_1.calculateMouseButtonValue)(options.options),
            type,
        }, MOUSE_EVENT_OPTIONS);
    }
    static delay(delay) {
        return {
            type: types_1.EventType.Delay,
            options: { delay },
        };
    }
    static keyDown(keyInfo) {
        return {
            type: types_1.EventType.Keyboard,
            options: CDPEventDescriptor.createKeyDownOptions(keyInfo),
        };
    }
    static keyUp(keyInfo) {
        return {
            type: types_1.EventType.Keyboard,
            options: CDPEventDescriptor.createKeyUpOptions(keyInfo),
        };
    }
}
exports.default = CDPEventDescriptor;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtZGVzY3JpcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9uYXRpdmUtYXV0b21hdGlvbi9jbGllbnQvZXZlbnQtZGVzY3JpcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG9DQUFxQztBQUVyQyxtQ0FBNEM7QUFDNUMsYUFBYTtBQUNiLG1GQUEyRDtBQUMzRCxtQ0FBZ0Y7QUFFaEYsMEdBQStFO0FBQy9FLHFEQUFpRTtBQUNqRSx5REFBNkY7QUFFN0YsTUFBTSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLEdBQUcsb0JBQVUsQ0FBQztBQUUxRCxNQUFNLGNBQWMsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDO0FBRTVDLE1BQU0sbUJBQW1CLEdBQUc7SUFDeEIsVUFBVSxFQUFFLENBQUM7Q0FDaEIsQ0FBQztBQUVGLE1BQU0sb0NBQW9DLEdBQUksb0RBQW9ELENBQUM7QUFDbkcsTUFBTSxxQ0FBcUMsR0FBRyxxREFBcUQsQ0FBQztBQUVwRyxTQUFTLGVBQWUsQ0FBRSxZQUFpQjtJQUN2QyxNQUFNLElBQUksR0FBTyxZQUFZLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUN0RCxNQUFNLE9BQU8sR0FBSSxJQUFBLDRCQUFvQixFQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUEsOEJBQXNCLEVBQUMsWUFBWSxDQUFDLENBQUM7SUFFdEQsT0FBTztRQUNILENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUk7UUFDM0MsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUMsR0FBRztLQUMzQyxDQUFDO0FBQ04sQ0FBQztBQUVELGlDQUFpQztBQUNqQyxjQUFjLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQywwQkFBMEIsRUFBRSxL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IHsgRXZlbnRUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgU2ltdWxhdGVkS2V5SW5mbyB9IGZyb20gJy4va2V5LXByZXNzL3V0aWxzJztcbmltcG9ydCB7IEtleU1vZGlmaWVyVmFsdWVzIH0gZnJvbSAnLi90eXBlcyc7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgaGFtbWVyaGVhZCBmcm9tICcuLi8uLi9jbGllbnQvY29yZS9kZXBzL2hhbW1lcmhlYWQnO1xuaW1wb3J0IHsgY2FsY3VsYXRlS2V5TW9kaWZpZXJzVmFsdWUsIGNhbGN1bGF0ZU1vdXNlQnV0dG9uVmFsdWUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IEF4aXNWYWx1ZXNEYXRhIH0gZnJvbSAnLi4vLi4vY2xpZW50L2NvcmUvdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCBzZW5kUmVxdWVzdFRvRnJhbWUgZnJvbSAnLi4vLi4vY2xpZW50L2NvcmUvdXRpbHMvc2VuZC1yZXF1ZXN0LXRvLWZyYW1lJztcbmltcG9ydCB7IGZpbmRJZnJhbWVCeVdpbmRvdyB9IGZyb20gJy4uLy4uL2NsaWVudC9jb3JlL3V0aWxzL2RvbSc7XG5pbXBvcnQgeyBnZXRCb3JkZXJzV2lkdGhGbG9hdCwgZ2V0RWxlbWVudFBhZGRpbmdGbG9hdCB9IGZyb20gJy4uLy4uL2NsaWVudC9jb3JlL3V0aWxzL3N0eWxlJztcblxuY29uc3QgeyB1dGlscywgZXZlbnRTYW5kYm94LCBuYXRpdmVNZXRob2RzIH0gPSBoYW1tZXJoZWFkO1xuXG5jb25zdCBtZXNzYWdlU2FuZGJveCA9IGV2ZW50U2FuZGJveC5tZXNzYWdlO1xuXG5jb25zdCBNT1VTRV9FVkVOVF9PUFRJT05TID0ge1xuICAgIGNsaWNrQ291bnQ6IDEsXG59O1xuXG5jb25zdCBDQUxDVUxBVEVfVE9QX0xFRlRfUE9JTlRfUkVRVUVTVF9DTUQgID0gJ25hdGl2ZS1hdXRvbWF0aW9ufGNhbGN1bGF0ZS10b3AtbGVmdC1wb2ludHxyZXF1ZXN0JztcbmNvbnN0IENBTENVTEFURV9UT1BfTEVGVF9QT0lOVF9SRVNQT05TRV9DTUQgPSAnbmF0aXZlLWF1dG9tYXRpb258Y2FsY3VsYXRlLXRvcC1sZWZ0LXBvaW50fHJlc3BvbnNlJztcblxuZnVuY3Rpb24gZ2V0TGVmdFRvcFBvaW50IChkcml2ZXJJZnJhbWU6IGFueSk6IEF4aXNWYWx1ZXNEYXRhPG51bWJlcj4ge1xuICAgIGNvbnN0IHJlY3QgICAgID0gZHJpdmVySWZyYW1lLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IGJvcmRlcnMgID0gZ2V0Qm9yZGVyc1dpZHRoRmxvYXQoZHJpdmVySWZyYW1lKTtcbiAgICBjb25zdCBwYWRkaW5ncyA9IGdldEVsZW1lbnRQYWRkaW5nRmxvYXQoZHJpdmVySWZyYW1lKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHg6IHJlY3QubGVmdCArIGJvcmRlcnMubGVmdCArIHBhZGRpbmdzLmxlZnQsXG4gICAgICAgIHk6IHJlY3QudG9wICsgYm9yZGVycy50b3AgKyBwYWRkaW5ncy50b3AsXG4gICAgfTtcbn1cblxuLy8gU2V0dXAgY3Jvc3MtaWZyYW1lIGludGVyYWN0aW9uXG5tZXNzYWdlU2FuZGJveC5vbihtZXNzYWdlU2FuZGJveC5TRVJWSUNFX01TR19SRUNFSVZFRF9FVkVOVCwgYXN5bmMgKGU6YW55KSA9PiB7XG4gICAgaWYgKGUubWVzc2FnZS5jbWQgPT09IENBTENVTEFURV9UT1BfTEVGVF9QT0lOVF9SRVFVRVNUX0NNRCkge1xuICAgICAgICBjb25zdCBpZnJhbWVXaW4gPSBlLnNvdXJjZTtcblxuICAgICAgICBjb25zdCB7IHgsIHkgfSA9IGF3YWl0IGNhbGN1bGF0ZUlGcmFtZVRvcExlZnRQb2ludCgpO1xuXG4gICAgICAgIGNvbnN0IGlmcmFtZSA9IGZpbmRJZnJhbWVCeVdpbmRvdyhpZnJhbWVXaW4pO1xuICAgICAgICBjb25zdCB0b3BMZWZ0UG9pbnQgPSBnZXRMZWZ0VG9wUG9pbnQoaWZyYW1lKTtcblxuICAgICAgICBjb25zdCByZXNwb25zZU1zZyA9IHtcbiAgICAgICAgICAgIGNtZDogICAgICAgICAgQ0FMQ1VMQVRFX1RPUF9MRUZUX1BPSU5UX1JFU1BPTlNFX0NNRCxcbiAgICAgICAgICAgIHRvcExlZnRQb2ludDoge1xuICAgICAgICAgICAgICAgIHg6IHRvcExlZnRQb2ludC54ICsgeCxcbiAgICAgICAgICAgICAgICB5OiB0b3BMZWZ0UG9pbnQueSArIHksXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuXG4gICAgICAgIG1lc3NhZ2VTYW5kYm94LnNlbmRTZXJ2aWNlTXNnKHJlc3BvbnNlTXNnLCBpZnJhbWVXaW4pO1xuICAgIH1cbn0pO1xuXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVJRnJhbWVUb3BMZWZ0UG9pbnQgKCk6IFByb21pc2U8QXhpc1ZhbHVlc0RhdGE8bnVtYmVyPj4ge1xuICAgIGlmICh3aW5kb3cgIT09IHdpbmRvdy5wYXJlbnQpIHtcbiAgICAgICAgY29uc3QgbXNnOiBhbnkgPSB7XG4gICAgICAgICAgICBjbWQ6IENBTENVTEFURV9UT1BfTEVGVF9QT0lOVF9SRVFVRVNUX0NNRCxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCB7IHRvcExlZnRQb2ludCB9ID0gYXdhaXQgc2VuZFJlcXVlc3RUb0ZyYW1lKG1zZywgQ0FMQ1VMQVRFX1RPUF9MRUZUX1BPSU5UX1JFU1BPTlNFX0NNRCwgd2luZG93LnBhcmVudCk7XG5cbiAgICAgICAgcmV0dXJuIHRvcExlZnRQb2ludDtcbiAgICB9XG5cbiAgICByZXR1cm4geyB4OiAwLCB5OiAwIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENEUEV2ZW50RGVzY3JpcHRvciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2lzTm9uQ2hhcktleU1vZGlmaWVyIChtb2RpZmllcnM6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBub25DaGFyTW9kaWZpZXJzID0gW0tleU1vZGlmaWVyVmFsdWVzLmN0cmwsIEtleU1vZGlmaWVyVmFsdWVzLmFsdCwgS2V5TW9kaWZpZXJWYWx1ZXMubWV0YV07XG5cbiAgICAgICAgcmV0dXJuIG5hdGl2ZU1ldGhvZHMuYXJyYXlJbmRleE9mLmNhbGwobm9uQ2hhck1vZGlmaWVycywgbW9kaWZpZXJzKSA+IC0xO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXRLZXlEb3duRXZlbnRUZXh0IChvcHRpb25zOiBTaW11bGF0ZWRLZXlJbmZvKTogYW55IHtcbiAgICAgICAgaWYgKG9wdGlvbnMuaXNOZXdMaW5lKVxuICAgICAgICAgICAgcmV0dXJuICdcXHInO1xuXG4gICAgICAgIGlmIChvcHRpb25zLmtleVByb3BlcnR5Lmxlbmd0aCA9PT0gMSAmJiAhQ0RQRXZlbnREZXNjcmlwdG9yLl9pc05vbkNoYXJLZXlNb2RpZmllcihvcHRpb25zLm1vZGlmaWVycykpXG4gICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5rZXlQcm9wZXJ0eTtcblxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGVLZXlEb3duT3B0aW9ucyAob3B0aW9uczogU2ltdWxhdGVkS2V5SW5mbyk6IGFueSB7XG4gICAgICAgIGNvbnN0IHRleHQgPSBDRFBFdmVudERlc2NyaXB0b3IuX2dldEtleURvd25FdmVudFRleHQob3B0aW9ucyk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6ICAgICAgICAgICAgICAgICAgdGV4dCA/ICdrZXlEb3duJyA6ICdyYXdLZXlEb3duJyxcbiAgICAgICAgICAgIG1vZGlmaWVyczogICAgICAgICAgICAgb3B0aW9ucy5tb2RpZmllcnMgfHwgMCxcbiAgICAgICAgICAgIHdpbmRvd3NWaXJ0dWFsS2V5Q29kZTogb3B0aW9ucy5rZXlDb2RlLFxuICAgICAgICAgICAga2V5OiAgICAgICAgICAgICAgICAgICBvcHRpb25zLmtleVByb3BlcnR5LFxuICAgICAgICAgICAgY29tbWFuZHM6ICAgICAgICAgICAgICBvcHRpb25zLmNvbW1hbmRzLFxuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUtleVVwT3B0aW9ucyAob3B0aW9uczogU2ltdWxhdGVkS2V5SW5mbyk6IGFueSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiAgICAgICAgICAgICAgICAgICdrZXlVcCcsXG4gICAgICAgICAgICBtb2RpZmllcnM6ICAgICAgICAgICAgIG9wdGlvbnMubW9kaWZpZXJzIHx8IDAsXG4gICAgICAgICAgICBrZXk6ICAgICAgICAgICAgICAgICAgIG9wdGlvbnMua2V5UHJvcGVydHksXG4gICAgICAgICAgICB3aW5kb3dzVmlydHVhbEtleUNvZGU6IG9wdGlvbnMua2V5Q29kZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZU1vdXNlRXZlbnRPcHRpb25zICh0eXBlOiBzdHJpbmcsIG9wdGlvbnM6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHsgeCwgeSB9ID0gYXdhaXQgY2FsY3VsYXRlSUZyYW1lVG9wTGVmdFBvaW50KCk7XG5cbiAgICAgICAgcmV0dXJuIHV0aWxzLmV4dGVuZCh7XG4gICAgICAgICAgICB4OiAgICAgICAgIG9wdGlvbnMub3B0aW9ucy5jbGllbnRYICsgeCxcbiAgICAgICAgICAgIHk6ICAgICAgICAgb3B0aW9ucy5vcHRpb25zLmNsaWVudFkgKyB5LFxuICAgICAgICAgICAgbW9kaWZpZXJzOiBjYWxjdWxhdGVLZXlNb2RpZmllcnNWYWx1ZShvcHRpb25zLm9wdGlvbnMpLFxuICAgICAgICAgICAgYnV0dG9uOiAgICBjYWxjdWxhdGVNb3VzZUJ1dHRvblZhbHVlKG9wdGlvbnMub3B0aW9ucyksXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICB9LCBNT1VTRV9FVkVOVF9PUFRJT05TKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGRlbGF5IChkZWxheTogbnVtYmVyKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6ICAgIEV2ZW50VHlwZS5EZWxheSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHsgZGVsYXkgfSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGtleURvd24gKGtleUluZm86IFNpbXVsYXRlZEtleUluZm8pOiBhbnkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogICAgRXZlbnRUeXBlLktleWJvYXJkLFxuICAgICAgICAgICAgb3B0aW9uczogQ0RQRXZlbnREZXNjcmlwdG9yLmNyZWF0ZUtleURvd25PcHRpb25zKGtleUluZm8pLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMga2V5VXAgKGtleUluZm86IFNpbXVsYXRlZEtleUluZm8pOiBhbnkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogICAgRXZlbnRUeXBlLktleWJvYXJkLFxuICAgICAgICAgICAgb3B0aW9uczogQ0RQRXZlbnREZXNjcmlwdG9yLmNyZWF0ZUtleVVwT3B0aW9ucyhrZXlJbmZvKSxcbiAgICAgICAgfTtcbiAgICB9XG59XG4iXX0=