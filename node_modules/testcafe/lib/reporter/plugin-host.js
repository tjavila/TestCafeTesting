"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const chalk_1 = __importDefault(require("chalk"));
const indent_string_1 = __importDefault(require("indent-string"));
const callsite_1 = __importDefault(require("callsite"));
const lodash_1 = require("lodash");
const moment_loader_1 = __importDefault(require("../utils/moment-loader"));
const string_1 = require("../utils/string");
const get_viewport_width_1 = __importDefault(require("../utils/get-viewport-width"));
const colors_1 = require("../utils/diff/colors");
const symbols_1 = __importDefault(require("../reporter/symbols"));
const plugin_methods_1 = __importDefault(require("./plugin-methods"));
// NOTE: we should not expose internal state to
// the plugin, to avoid accidental rewrites.
// Therefore we use symbols to store them.
const stream = Symbol();
const wordWrapEnabled = Symbol();
const indent = Symbol();
const errorDecorator = Symbol();
class ReporterPluginHost {
    constructor(plugin, outStream, name, pluginHooks) {
        this.name = name;
        this.streamController = null;
        this[stream] = outStream || process.stdout;
        this[wordWrapEnabled] = false;
        this[indent] = 0;
        const useColors = this[stream] === process.stdout && chalk_1.default.enabled && !plugin.noColors;
        this.chalk = new chalk_1.default.constructor({ enabled: useColors });
        this.moment = moment_loader_1.default;
        this.viewportWidth = (0, get_viewport_width_1.default)(this[stream]);
        this.symbols = Object.assign({}, symbols_1.default);
        (0, lodash_1.assignIn)(this, plugin);
        this._hooks = pluginHooks;
        this[errorDecorator] = this.createErrorDecorator();
    }
    // Error decorator
    createErrorDecorator() {
        return {
            'span user-agent': (str) => this.chalk.grey(str),
            'span subtitle': (str) => `- ${this.chalk.bold.red(str)} -`,
            'div message': (str) => this.chalk.bold.red(str),
            'div screenshot-info': lodash_1.identity,
            'a screenshot-path': (str) => this.chalk.grey.underline(str),
            'code': lodash_1.identity,
            'span syntax-string': (str) => this.chalk.green(str),
            'span syntax-punctuator': (str) => this.chalk.grey(str),
            'span syntax-keyword': (str) => this.chalk.cyan(str),
            'span syntax-number': (str) => this.chalk.magenta(str),
            'span syntax-regex': (str) => this.chalk.magenta(str),
            'span syntax-comment': (str) => this.chalk.grey.bold(str),
            'span syntax-invalid': (str) => this.chalk.inverse(str),
            [`span ${colors_1.DIFF_COLORS.DIFF_NOT_MODIFIED}`]: (str) => this.chalk.gray(str),
            [`span ${colors_1.DIFF_COLORS.DIFF_ADDED}`]: (str) => this.chalk.green(str),
            [`span ${colors_1.DIFF_COLORS.DIFF_REMOVED}`]: (str) => this.chalk.red(str),
            'div code-frame': lodash_1.identity,
            'div code-line': (str) => str + '\n',
            'div code-line-last': lodash_1.identity,
            'div code-line-num': (str) => `   ${str} |`,
            'div code-line-num-base': (str) => this.chalk.bgRed(` > ${str} `) + '|',
            'div code-line-src': lodash_1.identity,
            'div stack': (str) => '\n\n' + str,
            'div stack-line': (str) => str + '\n',
            'div stack-line-last': lodash_1.identity,
            'div stack-line-name': (str) => `   at ${this.chalk.bold(str)}`,
            'div stack-line-location': (str) => ` (${this.chalk.grey.underline(str)})`,
            'strong': (str) => this.chalk.bold(str),
            'a': (str) => `"${this.chalk.underline(str)}"`,
        };
    }
    // String helpers
    indentString(str, indentVal) {
        return (0, indent_string_1.default)(str, ' ', indentVal);
    }
    wordWrap(str, indentVal, width) {
        return (0, string_1.wordWrap)(str, indentVal, width);
    }
    escapeHtml(str) {
        return (0, lodash_1.escape)(str);
    }
    formatError(err, prefix = '') {
        const prefixLengthWithoutColors = (0, string_1.removeTTYColors)(prefix).length;
        const maxMsgLength = this.viewportWidth - this[indent] - prefixLengthWithoutColors;
        let msg = err.formatMessage(this[errorDecorator], maxMsgLength);
        if (this[wordWrapEnabled])
            msg = this.wordWrap(msg, prefixLengthWithoutColors, maxMsgLength);
        else
            msg = this.indentString(msg, prefixLengthWithoutColors);
        return prefix + msg.substr(prefixLengthWithoutColors);
    }
    // Writing helpers
    newline() {
        this._writeToUniqueStream('\n');
        return this;
    }
    write(text, data) {
        var _a;
        if (this[wordWrapEnabled])
            text = this.wordWrap(text, this[indent], this.viewportWidth);
        else
            text = this.indentString(text, this[indent]);
        if ((_a = this._hooks) === null || _a === void 0 ? void 0 : _a.onBeforeWrite) {
            const writeInfo = this._createBeforeWriteInfo(text, data);
            this._hooks.onBeforeWrite(writeInfo);
            this._writeToUniqueStream(writeInfo.formattedText);
        }
        else
            this._writeToUniqueStream(text);
        return this;
    }
    useWordWrap(use) {
        this[wordWrapEnabled] = use;
        return this;
    }
    setIndent(val) {
        this[indent] = val;
        return this;
    }
    _createBeforeWriteInfo(formattedText, data = {}) {
        const initiator = data.initiator || this._getWriteInitiatorEvent();
        return {
            formatOptions: {
                indent: this[indent],
                useWordWrap: this[wordWrapEnabled],
            },
            formattedText,
            initiator,
            data,
        };
    }
    _getWriteInitiatorEvent() {
        const pluginMethods = Object.keys(plugin_methods_1.default);
        const funcNames = (0, callsite_1.default)().map(site => site.getFunctionName());
        const initiator = funcNames.find(funcName => pluginMethods.some(methodName => methodName === funcName));
        return initiator || '';
    }
    _writeToUniqueStream(text) {
        if (!this.streamController || this.streamController.ensureUniqueStream(this[stream], this))
            this[stream].write(text);
    }
    // Abstract methods implemented in plugin
    async reportTaskStart( /* startTime, userAgents, testCount, testStructure, taskProperties */) {
        throw new Error('Not implemented');
    }
    async reportFixtureStart( /* name, path */) {
        throw new Error('Not implemented');
    }
    // NOTE: It's an optional method
    // async reportTestStart (/* name, testMeta */) {
    //     throw new Error('Not implemented');
    // }
    async reportTestDone( /* name, testRunInfo */) {
        throw new Error('Not implemented');
    }
    async reportTaskDone( /* endTime, passed, warnings */) {
        throw new Error('Not implemented');
    }
    // NOTE: It's an optional method
    async init() {
        // Optional
    }
    // NOTE: It's an optional method
    async reportWarnings( /* warnings */) {
    }
    // NOTE: It's an optional method
    async reportData( /* testRun, ...data */) {
    }
}
exports.default = ReporterPluginHost;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLWhvc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVwb3J0ZXIvcGx1Z2luLWhvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxrREFBcUM7QUFDckMsa0VBQXlDO0FBQ3pDLHdEQUFnQztBQUVoQyxtQ0FJZ0I7QUFFaEIsMkVBQTRDO0FBQzVDLDRDQUE0RDtBQUM1RCxxRkFBMkQ7QUFDM0QsaURBQW1EO0FBS25ELGtFQUFtRDtBQUduRCxzRUFBb0Q7QUFFcEQsK0NBQStDO0FBQy9DLDRDQUE0QztBQUM1QywwQ0FBMEM7QUFDMUMsTUFBTSxNQUFNLEdBQVksTUFBTSxFQUFFLENBQUM7QUFDakMsTUFBTSxlQUFlLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFDakMsTUFBTSxNQUFNLEdBQVksTUFBTSxFQUFFLENBQUM7QUFDakMsTUFBTSxjQUFjLEdBQUksTUFBTSxFQUFFLENBQUM7QUFFakMsTUFBcUIsa0JBQWtCO0lBYW5DLFlBQW9CLE1BQVcsRUFBRSxTQUFvQixFQUFFLElBQWEsRUFBRSxXQUFpQztRQUNuRyxJQUFJLENBQUMsSUFBSSxHQUFlLElBQUksQ0FBQztRQUM3QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBWSxTQUFTLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUNwRCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBWSxDQUFDLENBQUM7UUFFMUIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLE9BQU8sQ0FBQyxNQUFNLElBQUksZUFBSyxDQUFDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFFdkYsSUFBSSxDQUFDLEtBQUssR0FBVyxJQUFJLGVBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxPQUFPLEVB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LEtBQUssQ0FBQyxJQUFJO1FBQ2IsV0FBVztJQUNmLENBQUM7SUFFRCxnQ0FBZ0M7SUFDekIsS0FBSyxDQUFDLGNBQWMsRUFBRSxjQUFjO0lBQzNDLENBQUM7SUFFRCxnQ0FBZ0M7SUFDekIsS0FBSyxDQUFDLFVBQVUsRUFBRSxzQkFBc0I7SUFDL0MsQ0FBQztDQUNKO0FBNU1ELHFDQTRNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsaywgeyBDaGFsayB9IGZyb20gJ2NoYWxrJztcbmltcG9ydCBpbmRlbnRTdHJpbmcgZnJvbSAnaW5kZW50LXN0cmluZyc7XG5pbXBvcnQgY2FsbHNpdGUgZnJvbSAnY2FsbHNpdGUnO1xuXG5pbXBvcnQge1xuICAgIGlkZW50aXR5LFxuICAgIGVzY2FwZSBhcyBlc2NhcGVIdG1sLFxuICAgIGFzc2lnbkluLFxufSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgbW9tZW50IGZyb20gJy4uL3V0aWxzL21vbWVudC1sb2FkZXInO1xuaW1wb3J0IHsgd29yZFdyYXAsIHJlbW92ZVRUWUNvbG9ycyB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5pbXBvcnQgZ2V0Vmlld3BvcnRXaWR0aCBmcm9tICcuLi91dGlscy9nZXQtdmlld3BvcnQtd2lkdGgnO1xuaW1wb3J0IHsgRElGRl9DT0xPUlMgfSBmcm9tICcuLi91dGlscy9kaWZmL2NvbG9ycyc7XG5pbXBvcnQgeyBNb21lbnQgfSBmcm9tICdtb21lbnQnO1xuaW1wb3J0IFJlcG9ydGVyU3RyZWFtQ29udHJvbGxlciBmcm9tICcuLi9ydW5uZXIvcmVwb3J0ZXItc3RyZWFtLWNvbnRyb2xsZXInO1xuaW1wb3J0IHsgV3JpdGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlciBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4vZm9ybWF0dGFibGUtYWRhcHRlcic7XG5pbXBvcnQgUkVQT1JURVJfU1lNQk9MUyBmcm9tICcuLi9yZXBvcnRlci9zeW1ib2xzJztcbmltcG9ydCB7IFJlcG9ydGVyU3ltYm9scyB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBSZXBvcnRlclBsdWdpbkhvb2tzLCBXcml0ZUluZm8gfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCBSZXBvcnRlclBsdWdpbk1ldGhvZCBmcm9tICcuL3BsdWdpbi1tZXRob2RzJztcblxuLy8gTk9URTogd2Ugc2hvdWxkIG5vdCBleHBvc2UgaW50ZXJuYWwgc3RhdGUgdG9cbi8vIHRoZSBwbHVnaW4sIHRvIGF2b2lkIGFjY2lkZW50YWwgcmV3cml0ZXMuXG4vLyBUaGVyZWZvcmUgd2UgdXNlIHN5bWJvbHMgdG8gc3RvcmUgdGhlbS5cbmNvbnN0IHN0cmVhbSAgICAgICAgICA9IFN5bWJvbCgpO1xuY29uc3Qgd29yZFdyYXBFbmFibGVkID0gU3ltYm9sKCk7XG5jb25zdCBpbmRlbnQgICAgICAgICAgPSBTeW1ib2woKTtcbmNvbnN0IGVycm9yRGVjb3JhdG9yICA9IFN5bWJvbCgpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXBvcnRlclBsdWdpbkhvc3Qge1xuICAgIHB1YmxpYyBuYW1lPzogc3RyaW5nO1xuICAgIHB1YmxpYyBzdHJlYW1Db250cm9sbGVyOiBSZXBvcnRlclN0cmVhbUNvbnRyb2xsZXIgfCBudWxsO1xuICAgIHB1YmxpYyBjaGFsazogQ2hhbGs7XG4gICAgcHVibGljIG1vbWVudDogTW9tZW50O1xuICAgIHB1YmxpYyB2aWV3cG9ydFdpZHRoOiBudW1iZXI7XG4gICAgcHVibGljIHN5bWJvbHM6IFJlcG9ydGVyU3ltYm9scztcbiAgICBwcml2YXRlIFtzdHJlYW1dOiBXcml0YWJsZTtcbiAgICBwcml2YXRlIFt3b3JkV3JhcEVuYWJsZWRdOiBib29sZWFuO1xuICAgIHByaXZhdGUgW2luZGVudF06IG51bWJlcjtcbiAgICBwcml2YXRlIFtlcnJvckRlY29yYXRvcl06IFJlY29yZDxzdHJpbmcsIEZ1bmN0aW9uPjtcbiAgICBwcml2YXRlIF9ob29rczogUmVwb3J0ZXJQbHVnaW5Ib29rcyB8IHVuZGVmaW5lZDtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAocGx1Z2luOiBhbnksIG91dFN0cmVhbT86IFdyaXRhYmxlLCBuYW1lPzogc3RyaW5nLCBwbHVnaW5Ib29rcz86IFJlcG9ydGVyUGx1Z2luSG9va3MpIHtcbiAgICAgICAgdGhpcy5uYW1lICAgICAgICAgICAgID0gbmFtZTtcbiAgICAgICAgdGhpcy5zdHJlYW1Db250cm9sbGVyID0gbnVsbDtcbiAgICAgICAgdGhpc1tzdHJlYW1dICAgICAgICAgID0gb3V0U3RyZWFtIHx8IHByb2Nlc3Muc3Rkb3V0O1xuICAgICAgICB0aGlzW3dvcmRXcmFwRW5hYmxlZF0gPSBmYWxzZTtcbiAgICAgICAgdGhpc1tpbmRlbnRdICAgICAgICAgID0gMDtcblxuICAgICAgICBjb25zdCB1c2VDb2xvcnMgPSB0aGlzW3N0cmVhbV0gPT09IHByb2Nlc3Muc3Rkb3V0ICYmIGNoYWxrLmVuYWJsZWQgJiYgIXBsdWdpbi5ub0NvbG9ycztcblxuICAgICAgICB0aGlzLmNoYWxrICAgICAgICAgPSBuZXcgY2hhbGsuY29uc3RydWN0b3IoeyBlbmFibGVkOiB1c2VDb2xvcnMgfSk7XG4gICAgICAgIHRoaXMubW9tZW50ICAgICAgICA9IG1vbWVudDtcbiAgICAgICAgdGhpcy52aWV3cG9ydFdpZHRoID0gZ2V0Vmlld3BvcnRXaWR0aCh0aGlzW3N0cmVhbV0pO1xuICAgICAgICB0aGlzLnN5bWJvbHMgICAgICAgPSBPYmplY3QuYXNzaWduKHt9LCBSRVBPUlRFUl9TWU1CT0xTKTtcblxuICAgICAgICBhc3NpZ25Jbih0aGlzLCBwbHVnaW4pO1xuXG4gICAgICAgIHRoaXMuX2hvb2tzID0gcGx1Z2luSG9va3M7XG5cbiAgICAgICAgdGhpc1tlcnJvckRlY29yYXRvcl0gPSB0aGlzLmNyZWF0ZUVycm9yRGVjb3JhdG9yKCk7XG4gICAgfVxuXG4gICAgLy8gRXJyb3IgZGVjb3JhdG9yXG4gICAgcHVibGljIGNyZWF0ZUVycm9yRGVjb3JhdG9yICgpOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbj4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ3NwYW4gdXNlci1hZ2VudCc6IChzdHI6IHN0cmluZykgPT4gdGhpcy5jaGFsay5ncmV5KHN0ciksXG5cbiAgICAgICAgICAgICdzcGFuIHN1YnRpdGxlJzogKHN0cjogc3RyaW5nKSA9PiBgLSAke3RoaXMuY2hhbGsuYm9sZC5yZWQoc3RyKX0gLWAsXG4gICAgICAgICAgICAnZGl2IG1lc3NhZ2UnOiAgIChzdHI6IHN0cmluZykgPT4gdGhpcy5jaGFsay5ib2xkLnJlZChzdHIpLFxuXG4gICAgICAgICAgICAnZGl2IHNjcmVlbnNob3QtaW5mbyc6IGlkZW50aXR5LFxuICAgICAgICAgICAgJ2Egc2NyZWVuc2hvdC1wYXRoJzogICAoc3RyOiBzdHJpbmcpID0+IHRoaXMuY2hhbGsuZ3JleS51bmRlcmxpbmUoc3RyKSxcblxuICAgICAgICAgICAgJ2NvZGUnOiBpZGVudGl0eSxcblxuICAgICAgICAgICAgJ3NwYW4gc3ludGF4LXN0cmluZyc6ICAgICAoc3RyOiBzdHJpbmcpID0+IHRoaXMuY2hhbGsuZ3JlZW4oc3RyKSxcbiAgICAgICAgICAgICdzcGFuIHN5bnRheC1wdW5jdHVhdG9yJzogKHN0cjogc3RyaW5nKSA9PiB0aGlzLmNoYWxrLmdyZXkoc3RyKSxcbiAgICAgICAgICAgICdzcGFuIHN5bnRheC1rZXl3b3JkJzogICAgKHN0cjogc3RyaW5nKSA9PiB0aGlzLmNoYWxrLmN5YW4oc3RyKSxcbiAgICAgICAgICAgICdzcGFuIHN5bnRheC1udW1iZXInOiAgICAgKHN0cjogc3RyaW5nKSA9PiB0aGlzLmNoYWxrLm1hZ2VudGEoc3RyKSxcbiAgICAgICAgICAgICdzcGFuIHN5bnRheC1yZWdleCc6ICAgICAgKHN0cjogc3RyaW5nKSA9PiB0aGlzLmNoYWxrLm1hZ2VudGEoc3RyKSxcbiAgICAgICAgICAgICdzcGFuIHN5bnRheC1jb21tZW50JzogICAgKHN0cjogc3RyaW5nKSA9PiB0aGlzLmNoYWxrLmdyZXkuYm9sZChzdHIpLFxuICAgICAgICAgICAgJ3NwYW4gc3ludGF4LWludmFsaWQnOiAgICAoc3RyOiBzdHJpbmcpID0+IHRoaXMuY2hhbGsuaW52ZXJzZShzdHIpLFxuXG4gICAgICAgICAgICBbYHNwYW4gJHtESUZGX0NPTE9SUy5ESUZGX05PVF9NT0RJRklFRH1gXTogKHN0cjogc3RyaW5nKSA9PiB0aGlzLmNoYWxrLmdyYXkoc3RyKSxcbiAgICAgICAgICAgIFtgc3BhbiAke0RJRkZfQ09MT1JTLkRJRkZfQURERUR9YF06ICAgICAgICAoc3RyOiBzdHJpbmcpID0+IHRoaXMuY2hhbGsuZ3JlZW4oc3RyKSxcbiAgICAgICAgICAgIFtgc3BhbiAke0RJRkZfQ09MT1JTLkRJRkZfUkVNT1ZFRH1gXTogICAgICAoc3RyOiBzdHJpbmcpID0+IHRoaXMuY2hhbGsucmVkKHN0ciksXG5cbiAgICAgICAgICAgICdkaXYgY29kZS1mcmFtZSc6ICAgICAgICAgaWRlbnRpdHksXG4gICAgICAgICAgICAnZGl2IGNvZGUtbGluZSc6ICAgICAgICAgIChzdHI6IHN0cmluZykgPT4gc3RyICsgJ1xcbicsXG4gICAgICAgICAgICAnZGl2IGNvZGUtbGluZS1sYXN0JzogICAgIGlkZW50aXR5LFxuICAgICAgICAgICAgJ2RpdiBjb2RlLWxpbmUtbnVtJzogICAgICAoc3RyOiBzdHJpbmcpID0+IGAgICAke3N0cn0gfGAsXG4gICAgICAgICAgICAnZGl2IGNvZGUtbGluZS1udW0tYmFzZSc6IChzdHI6IHN0cmluZykgPT4gdGhpcy5jaGFsay5iZ1JlZChgID4gJHtzdHJ9IGApICsgJ3wnLFxuICAgICAgICAgICAgJ2RpdiBjb2RlLWxpbmUtc3JjJzogICAgICBpZGVudGl0eSxcblxuICAgICAgICAgICAgJ2RpdiBzdGFjayc6ICAgICAgICAgICAgICAgKHN0cjogc3RyaW5nKSA9PiAnXFxuXFxuJyArIHN0cixcbiAgICAgICAgICAgICdkaXYgc3RhY2stbGluZSc6ICAgICAgICAgIChzdHI6IHN0cmluZykgPT4gc3RyICsgJ1xcbicsXG4gICAgICAgICAgICAnZGl2IHN0YWNrLWxpbmUtbGFzdCc6ICAgICBpZGVudGl0eSxcbiAgICAgICAgICAgICdkaXYgc3RhY2stbGluZS1uYW1lJzogICAgIChzdHI6IHN0cmluZykgPT4gYCAgIGF0ICR7dGhpcy5jaGFsay5ib2xkKHN0cil9YCxcbiAgICAgICAgICAgICdkaXYgc3RhY2stbGluZS1sb2NhdGlvbic6IChzdHI6IHN0cmluZykgPT4gYCAoJHt0aGlzLmNoYWxrLmdyZXkudW5kZXJsaW5lKHN0cil9KWAsXG5cbiAgICAgICAgICAgICdzdHJvbmcnOiAoc3RyOiBzdHJpbmcpID0+IHRoaXMuY2hhbGsuYm9sZChzdHIpLFxuICAgICAgICAgICAgJ2EnOiAgICAgIChzdHI6IHN0cmluZykgPT4gYFwiJHt0aGlzLmNoYWxrLnVuZGVybGluZShzdHIpfVwiYCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBTdHJpbmcgaGVscGVyc1xuICAgIHB1YmxpYyBpbmRlbnRTdHJpbmcgKHN0cjogc3RyaW5nLCBpbmRlbnRWYWw6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBpbmRlbnRTdHJpbmcoc3RyLCAnICcsIGluZGVudFZhbCk7XG4gICAgfVxuXG4gICAgcHVibGljIHdvcmRXcmFwIChzdHI6IHN0cmluZywgaW5kZW50VmFsOiBudW1iZXIsIHdpZHRoOiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gd29yZFdyYXAoc3RyLCBpbmRlbnRWYWwsIHdpZHRoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXNjYXBlSHRtbCAoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gZXNjYXBlSHRtbChzdHIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBmb3JtYXRFcnJvciAoZXJyOiBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXIsIHByZWZpeCA9ICcnKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcHJlZml4TGVuZ3RoV2l0aG91dENvbG9ycyA9IHJlbW92ZVRUWUNvbG9ycyhwcmVmaXgpLmxlbmd0aDtcbiAgICAgICAgY29uc3QgbWF4TXNnTGVuZ3RoICAgICAgICAgICAgICA9IHRoaXMudmlld3BvcnRXaWR0aCAtIHRoaXNbaW5kZW50XSAtIHByZWZpeExlbmd0aFdpdGhvdXRDb2xvcnM7XG5cbiAgICAgICAgbGV0IG1zZyA9IGVyci5mb3JtYXRNZXNzYWdlKHRoaXNbZXJyb3JEZWNvcmF0b3JdLCBtYXhNc2dMZW5ndGgpO1xuXG4gICAgICAgIGlmICh0aGlzW3dvcmRXcmFwRW5hYmxlZF0pXG4gICAgICAgICAgICBtc2cgPSB0aGlzLndvcmRXcmFwKG1zZywgcHJlZml4TGVuZ3RoV2l0aG91dENvbG9ycywgbWF4TXNnTGVuZ3RoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgbXNnID0gdGhpcy5pbmRlbnRTdHJpbmcobXNnLCBwcmVmaXhMZW5ndGhXaXRob3V0Q29sb3JzKTtcblxuICAgICAgICByZXR1cm4gcHJlZml4ICsgbXNnLnN1YnN0cihwcmVmaXhMZW5ndGhXaXRob3V0Q29sb3JzKTtcbiAgICB9XG5cblxuICAgIC8vIFdyaXRpbmcgaGVscGVyc1xuICAgIHB1YmxpYyBuZXdsaW5lICgpOiBSZXBvcnRlclBsdWdpbkhvc3Qge1xuICAgICAgICB0aGlzLl93cml0ZVRvVW5pcXVlU3RyZWFtKCdcXG4nKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgd3JpdGUgKHRleHQ6IHN0cmluZywgZGF0YT86IGFueSk6IFJlcG9ydGVyUGx1Z2luSG9zdCB7XG4gICAgICAgIGlmICh0aGlzW3dvcmRXcmFwRW5hYmxlZF0pXG4gICAgICAgICAgICB0ZXh0ID0gdGhpcy53b3JkV3JhcCh0ZXh0LCB0aGlzW2luZGVudF0sIHRoaXMudmlld3BvcnRXaWR0aCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRleHQgPSB0aGlzLmluZGVudFN0cmluZyh0ZXh0LCB0aGlzW2luZGVudF0pO1xuXG4gICAgICAgIGlmICh0aGlzLl9ob29rcz8ub25CZWZvcmVXcml0ZSkge1xuICAgICAgICAgICAgY29uc3Qgd3JpdGVJbmZvID0gdGhpcy5fY3JlYXRlQmVmb3JlV3JpdGVJbmZvKHRleHQsIGRhdGEpO1xuXG4gICAgICAgICAgICB0aGlzLl9ob29rcy5vbkJlZm9yZVdyaXRlKHdyaXRlSW5mbyk7XG4gICAgICAgICAgICB0aGlzLl93cml0ZVRvVW5pcXVlU3RyZWFtKHdyaXRlSW5mby5mb3JtYXR0ZWRUZXh0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLl93cml0ZVRvVW5pcXVlU3RyZWFtKHRleHQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB1c2VXb3JkV3JhcCAodXNlOiBib29sZWFuKTogUmVwb3J0ZXJQbHVnaW5Ib3N0IHtcbiAgICAgICAgdGhpc1t3b3JkV3JhcEVuYWJsZWRdID0gdXNlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRJbmRlbnQgKHZhbDogbnVtYmVyKTogUmVwb3J0ZXJQbHVnaW5Ib3N0IHtcbiAgICAgICAgdGhpc1tpbmRlbnRdID0gdmFsO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZUJlZm9yZVdyaXRlSW5mbyAoZm9ybWF0dGVkVGV4dDogc3RyaW5nLCBkYXRhOiBhbnkgPSB7fSk6IFdyaXRlSW5mbyB7XG4gICAgICAgIGNvbnN0IGluaXRpYXRvciA9IGRhdGEuaW5pdGlhdG9yIHx8IHRoaXMuX2dldFdyaXRlSW5pdGlhdG9yRXZlbnQoKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZm9ybWF0T3B0aW9uczoge1xuICAgICAgICAgICAgICAgIGluZGVudDogICAgICB0aGlzW2luZGVudF0sXG4gICAgICAgICAgICAgICAgdXNlV29yZFdyYXA6IHRoaXNbd29yZFdyYXBFbmFibGVkXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmb3JtYXR0ZWRUZXh0LFxuICAgICAgICAgICAgaW5pdGlhdG9yLFxuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRXcml0ZUluaXRpYXRvckV2ZW50ICgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwbHVnaW5NZXRob2RzID0gT2JqZWN0LmtleXMoUmVwb3J0ZXJQbHVnaW5NZXRob2QpO1xuICAgICAgICBjb25zdCBmdW5jTmFtZXMgPSBjYWxsc2l0ZSgpLm1hcChzaXRlID0+IHNpdGUuZ2V0RnVuY3Rpb25OYW1lKCkpO1xuICAgICAgICBjb25zdCBpbml0aWF0b3IgPSBmdW5jTmFtZXMuZmluZChmdW5jTmFtZSA9PiBwbHVnaW5NZXRob2RzLnNvbWUobWV0aG9kTmFtZSA9PiBtZXRob2ROYW1lID09PSBmdW5jTmFtZSkpO1xuXG4gICAgICAgIHJldHVybiBpbml0aWF0b3IgfHwgJyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfd3JpdGVUb1VuaXF1ZVN0cmVhbSAodGV4dDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5zdHJlYW1Db250cm9sbGVyIHx8IHRoaXMuc3RyZWFtQ29udHJvbGxlci5lbnN1cmVVbmlxdWVTdHJlYW0odGhpc1tzdHJlYW1dLCB0aGlzKSlcbiAgICAgICAgICAgIHRoaXNbc3RyZWFtXS53cml0ZSh0ZXh0KTtcbiAgICB9XG5cblxuICAgIC8vIEFic3RyYWN0IG1ldGhvZHMgaW1wbGVtZW50ZWQgaW4gcGx1Z2luXG4gICAgcHVibGljIGFzeW5jIHJlcG9ydFRhc2tTdGFydCAoLyogc3RhcnRUaW1lLCB1c2VyQWdlbnRzLCB0ZXN0Q291bnQsIHRlc3RTdHJ1Y3R1cmUsIHRhc2tQcm9wZXJ0aWVzICovKTogUHJvbWlzZTxuZXZlcj4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCcpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyByZXBvcnRGaXh0dXJlU3RhcnQgKC8qIG5hbWUsIHBhdGggKi8pOiBQcm9taXNlPG5ldmVyPiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkJyk7XG4gICAgfVxuXG4gICAgLy8gTk9URTogSXQncyBhbiBvcHRpb25hbCBtZXRob2RcbiAgICAvLyBhc3luYyByZXBvcnRUZXN0U3RhcnQgKC8qIG5hbWUsIHRlc3RNZXRhICovKSB7XG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkJyk7XG4gICAgLy8gfVxuXG4gICAgcHVibGljIGFzeW5jIHJlcG9ydFRlc3REb25lICgvKiBuYW1lLCB0ZXN0UnVuSW5mbyAqLyk6IFByb21pc2U8bmV2ZXI+IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgaW1wbGVtZW50ZWQnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVwb3J0VGFza0RvbmUgKC8qIGVuZFRpbWUsIHBhc3NlZCwgd2FybmluZ3MgKi8pOiBQcm9taXNlPG5ldmVyPiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkJyk7XG4gICAgfVxuXG4gICAgLy8gTk9URTogSXQncyBhbiBvcHRpb25hbCBtZXRob2RcbiAgICBwdWJsaWMgYXN5bmMgaW5pdCAoKTogUHJvbWlzZTx2b2lkPiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uXG4gICAgICAgIC8vIE9wdGlvbmFsXG4gICAgfVxuXG4gICAgLy8gTk9URTogSXQncyBhbiBvcHRpb25hbCBtZXRob2RcbiAgICBwdWJsaWMgYXN5bmMgcmVwb3J0V2FybmluZ3MgKC8qIHdhcm5pbmdzICovKTogUHJvbWlzZTx2b2lkPiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uXG4gICAgfVxuXG4gICAgLy8gTk9URTogSXQncyBhbiBvcHRpb25hbCBtZXRob2RcbiAgICBwdWJsaWMgYXN5bmMgcmVwb3J0RGF0YSAoLyogdGVzdFJ1biwgLi4uZGF0YSAqLyk6IFByb21pc2U8dm9pZD4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvblxuICAgIH1cbn1cbiJdfQ==